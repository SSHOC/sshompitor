<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hits Over Time</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Chart.js adapter for date-fns to handle time scales -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- date-fns for date formatting -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@4.1.0/cdn.min.js"></script>

    <style>
        #container {
            display: flex;
            justify-content: space-between;
        }

        #chartContainer {
            width: 60%;
            height: 50vh;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        #dataTable {
            width: 35%;
            border-collapse: collapse;
        }

        #dataTable th, #dataTable td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        #dataTable th {
            background-color: #f2f2f2;
        }

        /* Green for positive changes, red for negative */
        .positive {
            background-color: #c8e6c9; /* light green */
        }

        .negative {
            background-color: #ffcdd2; /* light red */
        }

        #sourcePieContainer {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        #pieChartContainer {
            width: 45%;
        }

        #sourceDataTable {
            width: 50%;
            border-collapse: collapse;
        }

        #sourceDataTable th, #sourceDataTable td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        #sourceDataTable th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Total number of items in the SSHOMP</h1>

    <div id="container">
        <div id="chartContainer">
            <canvas id="hitsChart"></canvas>
        </div>

        <table id="dataTable">
            <caption>Change in items (1-day, 7-day, 30-day)</caption>
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>1-day</th>
                    <th>7-day</th>
                    <th>30-day</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- New Pie Chart and Table Section -->
    <div id="sourcePieContainer">
        <div id="pieChartContainer">
            <canvas id="sourcePieChart"></canvas>
        </div>

        <table id="sourceDataTable">
            <caption>Items per Source</caption>
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Items</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
    async function fetchJSON(file) {
        const response = await fetch(file);
        if (!response.ok) {
            console.error("Error fetching " + file);
            return null;
        }
        return await response.json();
    }

    // Populate the source table
    function populateSourceTable(sourceData, userCreatedItems) {
        const tableBody = document.querySelector('#sourceDataTable tbody');
        tableBody.innerHTML = '';  // Clear existing rows

        Object.keys(sourceData).forEach(source => {
            const row = document.createElement('tr');
            const labelCell = document.createElement('td');
            labelCell.textContent = source;

            const valueCell = document.createElement('td');
            // Ensure the sourceData values are numbers, not objects
            const itemsCount = typeof sourceData[source] === 'number' ? sourceData[source] : 'N/A';
            valueCell.textContent = itemsCount;

            row.appendChild(labelCell);
            row.appendChild(valueCell);
            tableBody.appendChild(row);
        });

        // Add "User-created items" row
        const row = document.createElement('tr');
        const labelCell = document.createElement('td');
        labelCell.textContent = 'User-created items';

        const valueCell = document.createElement('td');
        valueCell.textContent = isNaN(userCreatedItems) ? 'N/A' : userCreatedItems;  // Handle NaN case

        row.appendChild(labelCell);
        row.appendChild(valueCell);
        tableBody.appendChild(row);
    }

    // Render the pie chart
    function renderPieChart(sourceData, userCreatedItems) {
        const ctx = document.getElementById('sourcePieChart').getContext('2d');
        const labels = [...Object.keys(sourceData), 'User-created items'];
        const dataValues = [
            ...Object.keys(sourceData).map(source => typeof sourceData[source] === 'number' ? sourceData[source] : 0),
            userCreatedItems
        ];

        const pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { callbacks: { label: context => `${context.label}: ${context.raw} items` } }
                }
            }
        });
    }

    async function fetchAllData() {
        const itemsData = await fetchJSON('items.json');
        const sourcesData = await fetchJSON('sources.json');

        if (!itemsData || !sourcesData) return [];

        const hitsData = Object.keys(itemsData).map(timestamp => {
            const categories = itemsData[timestamp];
            return {
                timestamp: parseInt(timestamp),
                dataset: categories['dataset'],
                trainingMaterial: categories['training-material'],
                publication: categories['publication'],
                workflow: categories['workflow'],
                toolOrService: categories['tool-or-service'],
                total: (categories['dataset'] + categories['training-material'] + categories['publication'] + categories['workflow'] + categories['tool-or-service'])
            };
        });

        if (hitsData.length < 1) return;

        const changes1Day = calculateDifference(hitsData, 1);
        const changes7Day = calculateDifference(hitsData, 7);
        const changes30Day = calculateDifference(hitsData, 30);

        // Populate table with the differences from the latest data point
        populateTable(hitsData[hitsData.length - 1], changes1Day, changes7Day, changes30Day);

        // Calculate total items from the latest entry in items.json
        const totalItems = hitsData[hitsData.length - 1].total;

        // Ensure all source values are numbers and sum them
        const totalSourceItems = Object.values(sourcesData).reduce((sum, count) => sum + (typeof count === 'number' ? count : 0), 0);

        // Calculate "User-created items" (items without a source)
        const userCreatedItems = totalItems - totalSourceItems;

        // Populate the source table and render the pie chart
        populateSourceTable(sourcesData, userCreatedItems);
        renderPieChart(sourcesData, userCreatedItems);

        return hitsData;
    }

    fetchAllData().then(renderChart);
</script>
</body>
</html>
